<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.5.1"></script>
  <script src="https://toyohisa2nakada.github.io/nn_basic_lesson/machine_learning_internal.js"></script>
</head>

<body>
  <script>
    function createModel({ units, useBias, LearningRate }) {
      const model = tf.sequential();
      model.add(
        tf.layers.dense({
          inputShape: [1],
          units,
          useBias,
          activation: "tanh",
        }),
      );
      model.add(tf.layers.dense({ units: 1, useBias: false }));
      model.compile({
        optimizer: tf.train.adam(LearningRate),
        loss: tf.losses.meanSquaredError,
        metrics: ["mse"],
      });
      return model;
    }
    async function run({ model, values, ranges, tensors, epochs }) {
      const history = await model.fit(tensors.x, tensors.y, {
        batchSize: tensors.x.shape[0],
        epochs,
        shuffle: true,
        callbacks: tfvis.show.fitCallbacks(
          { name: "学習回数と誤差(MSE)" },
          ["mse"],
          { height: 100, callbacks: ["onEpochEnd"] },
        ),
      });
      const weights = model.getWeights();
      updateLearnedParams({
        w1: weights[0].dataSync(),
        b: weights[1].dataSync(),
        w2: weights[2].dataSync(),
      });
      const predicted = await transform({
        model,
        range: ranges.x,
        interval: 0.1,
      });
      updateScatterplot({ values: [predicted, values], ranges });
    }
    async function setup() {
      const data = {
        原点通る直線: [
          [-1, -1],
          [0, 0],
          [1, 1],
          [2, 2],
        ],
        原点通る折れ線: [
          [-1, -2],
          [0, 0],
          [1, 2],
          [2, 1],
        ],
        原点通らない直線: [
          [-1, -2],
          [0, -1],
          [1, 0],
          [2, 1],
        ],
        原点通らない折れ線: [
          [-1, -3],
          [0, -1],
          [1, 1],
          [2, 0],
        ],
      };
      const { values, ranges, tensors } = await getDataset(
        data?.["原点通らない折れ線"],
      );
      values !== undefined &&
        updateScatterplot({ values: [[], values], ranges });
      const model = createModel({
        units: 2,
        useBias: true,
        LearningRate: 0.05,
      });
      model !== undefined && setupVisor({
        onStart: () => run({ epochs: 50, model, values, ranges, tensors }),
      });
    }
    document.addEventListener("DOMContentLoaded", setup);
  </script>
</body>

</html>